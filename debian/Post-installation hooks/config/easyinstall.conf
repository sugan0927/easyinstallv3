#!/bin/bash
# EasyInstall Main Configuration File
# Location: /etc/easyinstall/easyinstall.conf
# This file is sourced by all EasyInstall scripts

# ============================================
# Package Information
# ============================================
EASYINSTALL_VERSION="3.0"
EASYINSTALL_NAME="EasyInstall Enterprise Stack"
EASYINSTALL_DESCRIPTION="Ultra-Optimized 512MB VPS → Enterprise Grade Hosting Engine"

# ============================================
# Path Configuration
# ============================================
EASYINSTALL_HOME="/usr/share/easyinstall"
EASYINSTALL_BIN="/usr/local/bin"
EASYINSTALL_CONFIG_DIR="/etc/easyinstall"
EASYINSTALL_LIB_DIR="/var/lib/easyinstall"
EASYINSTALL_LOG_DIR="/var/log/easyinstall"
EASYINSTALL_BACKUP_DIR="/var/backups/easyinstall"
EASYINSTALL_HOOKS_DIR="$EASYINSTALL_HOME/hooks"
EASYINSTALL_STATE_FILE="$EASYINSTALL_LIB_DIR/installed"
EASYINSTALL_TRANSACTION_LOG="$EASYINSTALL_LIB_DIR/transaction.log"

# ============================================
# Web Server Paths
# ============================================
WWW_ROOT="/var/www/html"
WWW_SITES="/var/www/sites"
NGINX_CONF_DIR="/etc/nginx"
NGINX_SITES_AVAILABLE="/etc/nginx/sites-available"
NGINX_SITES_ENABLED="/etc/nginx/sites-enabled"
NGINX_CACHE_DIR="/var/cache/nginx"

# ============================================
# Backup Paths
# ============================================
BACKUP_ROOT="/backups"
BACKUP_DAILY="$BACKUP_ROOT/daily"
BACKUP_WEEKLY="$BACKUP_ROOT/weekly"
BACKUP_MONTHLY="$BACKUP_ROOT/monthly"

# ============================================
# System Detection (Auto-populated)
# ============================================
TOTAL_RAM=$(free -m | awk '/Mem:/ {print $2}')
TOTAL_CORES=$(nproc)
IP_ADDRESS=$(hostname -I | awk '{print $1}' | head -1)
OS_VERSION=$(lsb_release -sc 2>/dev/null || echo "focal")
HOSTNAME_FQDN=$(hostname -f 2>/dev/null || hostname)

# ============================================
# Performance Tuning (Auto-calculated)
# ============================================
# PHP Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    PHP_MEMORY_LIMIT="128M"
    PHP_MAX_CHILDREN=4
    PHP_START_SERVERS=2
    PHP_MIN_SPARE=1
    PHP_MAX_SPARE=3
    PHP_OPCACHE_MEMORY=64
    PHP_MAX_EXECUTION_TIME=300
    PHP_POST_MAX_SIZE="64M"
    PHP_UPLOAD_MAX_SIZE="64M"
elif [ "$TOTAL_RAM" -le 1024 ]; then
    PHP_MEMORY_LIMIT="256M"
    PHP_MAX_CHILDREN=8
    PHP_START_SERVERS=3
    PHP_MIN_SPARE=2
    PHP_MAX_SPARE=6
    PHP_OPCACHE_MEMORY=128
    PHP_MAX_EXECUTION_TIME=300
    PHP_POST_MAX_SIZE="64M"
    PHP_UPLOAD_MAX_SIZE="64M"
else
    PHP_MEMORY_LIMIT="512M"
    PHP_MAX_CHILDREN=16
    PHP_START_SERVERS=4
    PHP_MIN_SPARE=2
    PHP_MAX_SPARE=8
    PHP_OPCACHE_MEMORY=256
    PHP_MAX_EXECUTION_TIME=300
    PHP_POST_MAX_SIZE="64M"
    PHP_UPLOAD_MAX_SIZE="64M"
fi

# MySQL/MariaDB Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    MYSQL_BUFFER_POOL_SIZE="32M"
    MYSQL_TMP_TABLE_SIZE="32M"
    MYSQL_MAX_CONNECTIONS=50
    MYSQL_JOIN_BUFFER_SIZE="1M"
    MYSQL_SORT_BUFFER_SIZE="2M"
elif [ "$TOTAL_RAM" -le 1024 ]; then
    MYSQL_BUFFER_POOL_SIZE="128M"
    MYSQL_TMP_TABLE_SIZE="64M"
    MYSQL_MAX_CONNECTIONS=75
    MYSQL_JOIN_BUFFER_SIZE="2M"
    MYSQL_SORT_BUFFER_SIZE="4M"
else
    MYSQL_BUFFER_POOL_SIZE="256M"
    MYSQL_TMP_TABLE_SIZE="128M"
    MYSQL_MAX_CONNECTIONS=100
    MYSQL_JOIN_BUFFER_SIZE="4M"
    MYSQL_SORT_BUFFER_SIZE="8M"
fi

# Redis Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    REDIS_MAXMEMORY="32mb"
    REDIS_MAXMEMORY_POLICY="allkeys-lru"
elif [ "$TOTAL_RAM" -le 1024 ]; then
    REDIS_MAXMEMORY="128mb"
    REDIS_MAXMEMORY_POLICY="allkeys-lru"
else
    REDIS_MAXMEMORY="256mb"
    REDIS_MAXMEMORY_POLICY="allkeys-lru"
fi

# Memcached Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    MEMCACHED_MEMORY="32"
elif [ "$TOTAL_RAM" -le 1024 ]; then
    MEMCACHED_MEMORY="128"
else
    MEMCACHED_MEMORY="256"
fi

# Nginx Cache Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    NGINX_CACHE_SIZE="100m"
    NGINX_CACHE_INACTIVE="30m"
elif [ "$TOTAL_RAM" -le 1024 ]; then
    NGINX_CACHE_SIZE="200m"
    NGINX_CACHE_INACTIVE="60m"
else
    NGINX_CACHE_SIZE="500m"
    NGINX_CACHE_INACTIVE="120m"
fi

# Swap Settings
if [ "$TOTAL_RAM" -le 512 ]; then
    SWAP_SIZE="1G"
    SWAPPINESS=60
    VFS_CACHE_PRESSURE=50
elif [ "$TOTAL_RAM" -le 1024 ]; then
    SWAP_SIZE="2G"
    SWAPPINESS=50
    VFS_CACHE_PRESSURE=50
else
    SWAP_SIZE="4G"
    SWAPPINESS=40
    VFS_CACHE_PRESSURE=50
fi

# ============================================
# Feature Toggles (User Configurable)
# ============================================

# WordPress Settings
ENABLE_THEME_EDITOR="true"           # Set to "false" to disable theme/plugin editor
DISABLE_XMLRPC="false"                # Set to "true" to block XML-RPC by default
WP_AUTO_UPDATE_CORE="minor"           # Options: "minor", "major", "false"
WP_POST_REVISIONS=5                    # Number of post revisions to keep
EMPTY_TRASH_DAYS=7                     # Days before empty trash
DISALLOW_FILE_EDIT="false"             # Keep false for editor enabled

# Security Settings
ENABLE_MODSECURITY="true"              # Enable ModSecurity WAF
ENABLE_FAIL2BAN="true"                  # Enable Fail2ban
AUTO_UPDATE_KEYS="true"                 # Auto-update WordPress security keys monthly
ENABLE_SSL_AUTO="true"                   # Auto-renew SSL certificates
ENABLE_SECURITY_HEADERS="true"           # Add security headers to nginx
ENABLE_WORDPRESS_HARDENING="true"        # Apply WordPress hardening rules

# Performance Settings
ENABLE_NGINX_CACHE="true"                # Enable FastCGI cache
ENABLE_REDIS="true"                       # Enable Redis caching
ENABLE_MEMCACHED="true"                    # Enable Memcached
ENABLE_OPCACHE="true"                       # Enable PHP OPcache
ENABLE_GZIP="true"                           # Enable GZIP compression
ENABLE_KERNEL_TUNING="true"                   # Apply kernel optimizations

# Monitoring Settings
ENABLE_NETDATA="true"                       # Enable Netdata monitoring
ENABLE_GLANCES="true"                        # Enable Glances monitoring
ENABLE_AUTOHEAL="true"                        # Enable auto-healing service
AUTOHEAL_INTERVAL="60"                         # Auto-heal check interval (seconds)
MONITORING_PORT_NETDATA="19999"                 # Netdata web interface port
MONITORING_PORT_GLANCES="61208"                  # Glances web interface port

# Backup Settings
ENABLE_BACKUPS="true"                          # Enable automated backups
BACKUP_RETENTION_DAYS="7"                        # Days to keep daily backups
BACKUP_RETENTION_WEEKS="4"                        # Weeks to keep weekly backups
BACKUP_RETENTION_MONTHS="3"                        # Months to keep monthly backups
BACKUP_TIME_DAILY="02:00"                          # Daily backup time (24h format)
BACKUP_TIME_WEEKLY="03:00"                          # Weekly backup time (Sunday)
BACKUP_TIME_MONTHLY="04:00"                          # Monthly backup time (1st of month)
REMOTE_BACKUP_ENABLED="false"                         # Enable remote backups
REMOTE_BACKUP_TYPE=""                                  # Options: "gdrive", "s3", "b2", "dropbox"
REMOTE_BACKUP_PATH=""                                   # Remote path for backups

# CDN Settings
ENABLE_CDN="false"                                     # Enable CDN integration
CDN_PROVIDER=""                                         # Options: "cloudflare"
CLOUDFLARE_EMAIL=""                                     # Cloudflare account email
CLOUDFLARE_API_KEY=""                                    # Cloudflare API key

# Email Settings
ENABLE_EMAIL_ALERTS="true"                              # Enable email alerts
ADMIN_EMAIL="admin@localhost"                            # Default admin email
ENABLE_TELEGRAM="false"                                   # Enable Telegram alerts
TELEGRAM_BOT_TOKEN=""                                      # Telegram bot token
TELEGRAM_CHAT_ID=""                                         # Telegram chat ID
SMTP_SERVER=""                                               # SMTP server for external email
SMTP_PORT="587"                                               # SMTP port
SMTP_USER=""                                                   # SMTP username
SMTP_PASS=""                                                    # SMTP password
SMTP_FROM=""                                                     # From email address

# Database Settings
MYSQL_ROOT_PASSWORD="root"                                   # MySQL root password (change after install)
MYSQL_SOCKET="/var/run/mysqld/mysqld.sock"                    # MySQL socket
MYSQL_CHARSET="utf8mb4"                                         # Default charset
MYSQL_COLLATION="utf8mb4_unicode_ci"                            # Default collation

# PHP Settings (Manual Override)
PHP_VERSION="auto"                                             # "auto" or specific version like "8.2"
PHP_TIMEZONE="UTC"                                              # PHP timezone
PHP_MAX_INPUT_VARS="3000"                                        # Max input variables
PHP_MAX_FILE_UPLOADS="20"                                         # Max file uploads
PHP_ALLOW_URL_FOPEN="On"                                           # Allow URL fopen
PHP_DISABLE_FUNCTIONS=""                                            # Disabled functions (comma-separated)

# Nginx Settings
NGINX_WORKER_CONNECTIONS="4096"                                   # Nginx worker connections
NGINX_KEEPALIVE_TIMEOUT="65"                                       # Keepalive timeout
NGINX_CLIENT_MAX_BODY_SIZE="64M"                                    # Max upload size
NGINX_SERVER_TOKENS="off"                                            # Hide nginx version

# Security Hardening
ENABLE_FAIL2BAN_WORDPRESS="true"                                   # Enable WordPress fail2ban rules
FAIL2BAN_BANTIME="3600"                                              # Ban time in seconds
FAIL2BAN_FINDTIME="600"                                               # Find time in seconds
FAIL2BAN_MAXRETRY="5"                                                  # Max retries before ban
ENABLE_UFW="true"                                                      # Enable UFW firewall
UFW_SSH_PORT="22"                                                       # SSH port
UFW_HTTP_PORT="80"                                                       # HTTP port
UFW_HTTPS_PORT="443"                                                      # HTTPS port

# Multi-site Settings
MULTISITE_ENABLED="true"                                               # Enable multi-site panel
MULTISITE_DEFAULT_PHP_VERSION="8.2"                                     # Default PHP version for new sites
MULTISITE_AUTO_SSL="true"                                                 # Auto-SSL for new sites

# Logging
LOG_LEVEL="info"                                                         # Log level: debug, info, warn, error
LOG_ROTATION_DAYS="30"                                                     # Days to keep logs
ENABLE_SYSLOG="true"                                                        # Enable syslog integration

# Development Settings
DEV_MODE="false"                                                           # Set to true for development
ENABLE_DEBUG="false"                                                        # Enable debug output
SKIP_CHECKS="false"                                                          # Skip system checks

# Auto-Healing Rules
AUTOHEAL_MAX_RESTART_ATTEMPTS="3"                                           # Max restart attempts
AUTOHEAL_DISK_THRESHOLD="95"                                                 # Disk usage % threshold
AUTOHEAL_MEMORY_THRESHOLD="90"                                                # Memory usage % threshold
AUTOHEAL_LOAD_THRESHOLD_MULTIPLIER="2"                                         # Load threshold multiplier (cores * this)

# ============================================
# Advanced Settings (Don't change unless you know what you're doing)
# ============================================
PHP_FPM_SOCKET_PATH="/run/php"
NGINX_MODULES_ENABLED="geoip image-filter njs perl xslt"
PHP_EXTENSIONS_ENABLED="mysql curl xml mbstring zip gd imagick opcache redis intl bcmath gmp xmlrpc memcache memcached"
WORDPRESS_PLUGINS_AUTOINSTALL="nginx-helper redis-cache w3-total-cache"
DEBIAN_FRONTEND="noninteractive"

# ============================================
# Load custom overrides (if exists)
# ============================================
if [ -f "$EASYINSTALL_CONFIG_DIR/custom.conf" ]; then
    source "$EASYINSTALL_CONFIG_DIR/custom.conf"
fi

# ============================================
# Export all variables for child processes
# ============================================
export EASYINSTALL_VERSION
export EASYINSTALL_NAME
export EASYINSTALL_DESCRIPTION
export TOTAL_RAM
export TOTAL_CORES
export IP_ADDRESS
export OS_VERSION
export HOSTNAME_FQDN
export WWW_ROOT
export WWW_SITES
export BACKUP_ROOT
export PHP_MEMORY_LIMIT
export PHP_MAX_CHILDREN
export PHP_START_SERVERS
export PHP_MIN_SPARE
export PHP_MAX_SPARE
export PHP_OPCACHE_MEMORY
export MYSQL_BUFFER_POOL_SIZE
export REDIS_MAXMEMORY
export MEMCACHED_MEMORY
export NGINX_CACHE_SIZE
export NGINX_CACHE_INACTIVE
export SWAP_SIZE
export SWAPPINESS
export VFS_CACHE_PRESSURE
export ENABLE_THEME_EDITOR
export DISABLE_XMLRPC
export ENABLE_MODSECURITY
export ENABLE_FAIL2BAN
export AUTO_UPDATE_KEYS
export ENABLE_AUTOHEAL
export AUTOHEAL_INTERVAL
export ENABLE_BACKUPS
export BACKUP_RETENTION_DAYS
export LOG_LEVEL

# ============================================
# Validation and Warnings
# ============================================
if [ "$DEV_MODE" = "true" ] && [ "$ENABLE_DEBUG" = "true" ]; then
    echo "⚠️  EasyInstall running in DEVELOPMENT mode with DEBUG enabled" >&2
    echo "   Configuration: $EASYINSTALL_CONFIG_DIR/easyinstall.conf" >&2
fi

# End of configuration